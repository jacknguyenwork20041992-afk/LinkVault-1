# Deployment Guide: Via English Academy Document Management System

## ðŸš€ Deploy to Render (Free Tier)

### Prerequisites
- GitHub repository with this codebase
- Supabase account with PostgreSQL database
- All API service accounts (Google OAuth, Gmail, Cloudinary, Gemini AI)

### Step 1: Repository Setup

1. **Push code to GitHub:**
   ```bash
   git add .
   git commit -m "Prepare for Render deployment"
   git push origin main
   ```

2. **Ensure render.yaml is in repository root** âœ…
   - File location: `./render.yaml`
   - Contains full-stack configuration with all environment variables

### Step 2: Create Render Service

1. **Login to Render Dashboard:**
   - Go to https://render.com
   - Sign in with GitHub account

2. **Create New Web Service:**
   - Click "New" â†’ "Web Service"
   - Connect your GitHub repository
   - Select the repository containing this codebase

3. **Auto-Configuration:**
   - Render will detect `render.yaml` automatically
   - Service name: `via-english-academy-fullstack`
   - Plan: Free (750 hours/month)

### Step 3: Configure Environment Variables

Set these environment variables in Render Dashboard:

#### Database
- `DATABASE_URL`: Your Supabase connection string (use Connection Pooler URL)
  ```
  postgres://postgres.[PROJECT_REF]:[PASSWORD]@aws-0-[REGION].pooler.supabase.com:5432/postgres
  ```

#### Google OAuth
- `GOOGLE_CLIENT_ID`: From Google Cloud Console
- `GOOGLE_CLIENT_SECRET`: From Google Cloud Console

#### Gmail Service
- `GMAIL_USER`: Your Gmail address
- `GMAIL_APP_PASSWORD`: App-specific password from Google Account

#### Cloudinary
- `CLOUDINARY_CLOUD_NAME`: From Cloudinary dashboard
- `CLOUDINARY_API_KEY`: From Cloudinary dashboard  
- `CLOUDINARY_API_SECRET`: From Cloudinary dashboard

#### AI Service
- `GEMINI_API_KEY`: From Google AI Studio

#### Auto-Generated
- `SESSION_SECRET`: Auto-generated by Render
- `ALLOWED_ORIGINS`: Set to your Render URL

### Step 4: Deploy

1. **Start Deployment:**
   - Click "Create Web Service"
   - Render will automatically start building

2. **Build Process:**
   ```
   npm install && npm run build
   ```
   - Frontend builds to `dist/public/`
   - Backend bundles to `dist/index.js`

3. **Start Command:**
   ```
   npm start
   ```
   - Runs production server on PORT (assigned by Render)

### Step 5: Post-Deployment Setup

1. **Update Google OAuth Settings:**
   - Go to Google Cloud Console
   - OAuth 2.0 Client IDs
   - Add authorized redirect URI:
     ```
     https://via-english-academy-fullstack.onrender.com/api/auth/google/callback
     ```

2. **Verify Health Endpoint:**
   ```
   https://via-english-academy-fullstack.onrender.com/api/health
   ```

3. **Test Core Features:**
   - âœ… Database connection
   - âœ… Google OAuth login
   - âœ… Static file serving
   - âœ… API endpoints

### Step 6: Production Database Connection

**Important:** Both development (Replit) and production (Render) will connect to the same Supabase database.

**Database URL Format (Connection Pooler):**
```
postgres://postgres.[PROJECT_REF]:[PASSWORD]@aws-0-[REGION].pooler.supabase.com:5432/postgres
```

**Why Connection Pooler:**
- Render free tier has IPv6 compatibility issues with direct connections
- Connection pooler provides IPv4 compatibility
- Better for serverless/free tier environments

### Step 7: Free Tier Optimizations

The app includes optimizations for Render free tier:

1. **Sleep Mode Recovery:**
   - Enhanced health endpoint with auto-reconnection
   - Database connection pool management
   - WebSocket reconnection logic

2. **Resource Management:**
   - Connection pool: max 5, min 0
   - Optimized for cold starts
   - Memory-efficient session storage

3. **Monitoring:**
   - Health checks every 30 seconds
   - Database connectivity verification
   - Response time monitoring

### Troubleshooting

#### Common Issues:

1. **Build Fails:**
   - Check Node.js version compatibility
   - Verify all dependencies in package.json

2. **Database Connection Issues:**
   - Ensure using Connection Pooler URL (not direct connection)
   - Verify Supabase allows connections from external IPs

3. **Static Files Not Loading:**
   - Build creates files in `dist/public/`
   - Server serves from correct path in production

4. **OAuth Issues:**
   - Update redirect URIs in Google Cloud Console
   - Verify CLIENT_ID and CLIENT_SECRET

#### Logs and Debugging:
- View logs in Render Dashboard
- Health endpoint: `/api/health`
- Database status included in health response

### Success Indicators:

âœ… **Deployment Complete When:**
- Build completes successfully
- Health endpoint returns 200 OK
- Database shows "healthy" status
- Google OAuth login works
- Static frontend loads correctly
- All API endpoints respond

### Domain and SSL:
- Custom domain: `via-english-academy-fullstack.onrender.com`
- SSL certificate: Auto-provisioned by Render
- Both www and non-www supported

---

**Total Cost: $0/month**
- Render: Free tier (750 hours)
- Supabase: Free tier (up to 500MB, 2 projects)
- All API services using free tiers

**Uptime: ~31 days/month** (with sleep mode on inactivity)